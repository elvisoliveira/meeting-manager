<!DOCTYPE html>
<html>

<head>
    <link href="board.scss" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans|Fira+Sans|Open+Sans|Oranienbaum" rel="stylesheet" />
    <style>
        @page {
            margin: 5mm;
        }
    </style>
    <meta charset="utf8" />
    <title>Reunião do meio de semana</title>
</head>

<body>
    <table class="schedule">
        <thead>
            <tr>
                <td>Den Haag-Portugees</td>
                <td>Reunião do meio de semana</td>
            </tr>
            <tr>
                <td colspan="2">
                    <hr />
                </td>
            </tr>
        </thead>
        <tbody id="boot">
            <tr>
                <td>Loading...</td>
            </tr>
        </tbody>
    </table>
    <script type="x-tmpl-mustache" id="template">
        {{#each meetings}}
            <tr>
                <td colspan="2">
                    <table class="meeting">
                        <tr class="head">
                            <td class="label" colspan="4">{{this.label}} - {{this.theme}}</td>
                            <td class="title">Presidente</td>
                            <td class="assigned">{{this.chairman}}</td>
                        </tr>
                        <tr>
                            <td class="time">{{time 5}}</td>
                            <td colspan="5">Cântico: <strong>{{this.opening_song}}</strong></td>
                        </tr>
                        <tr>
                            <td class="time">{{time 1}}</td>
                            <td colspan="5">Comentários iniciais</td>
                        </tr>
                        <tr class="treasures">
                            <td><img src="treasures.svg" /></td>
                            <td colspan="5"><span>TESOUROS DA PALAVRA DE DEUS</span></td>
                        </tr>
                        {{#with this.opening_talk}}
                        <tr>
                            <td class="time">{{time time}}</td>
                            <td colspan="4">{{title}}</td>
                            <td class="assigned">{{speaker}}</td>
                        </tr>
                        {{/with}}
                        {{#with this.spiritual_gems}}
                        <tr>
                            <td class="time">{{time time}}</td>
                            <td colspan="4">{{title}}</td>
                            <td class="assigned">{{conductor}}</td>
                        </tr>
                        {{/with}}
                        {{#with this.bible_reading}}
                        <tr>
                            <td class="time">{{time time}}</td>
                            <td colspan="3">{{title}}</td>
                            <td class="title">Estudante</td>
                            <td class="assigned">{{reader}}</td>
                        </tr>
                        {{/with}}
                        <tr class="apply">
                            <td><img src="apply.svg" /></td>
                            <td colspan="3"><span>FAÇA SEU MELHOR NO MINISTÉRIO</span></td>
                        </tr>
                        {{#each this.apply_yourself_to_the_field_ministry}}
                        <tr>
                            <td class="time">{{time this.time}}</td>
                            <td colspan="{{#if this.assistant}}0{{else}}3{{/if}}">{{this.title}}</td>
                            <td class="title">Estudante</td>
                            <td class="assigned">{{this.assigned}}</td>
                            {{#if this.assistant}}
                            <td class="title">Ajudante</td>
                            <td class="assigned">{{this.assistant}}</td>
                            {{/if}}
                        </tr>
                        {{/each}}
                        <tr class="living">
                            <td><img src="living.svg" /></td>
                            <td colspan="6"><span>NOSSA VIDA CRISTÃ</span></td>
                        </tr>
                        <tr>
                            <td class="time">{{time 5}}</td>
                            <td colspan="5">Cântico: <strong>116</strong></td>
                        </tr>
                        {{#each this.living_as_christians}}
                        <tr>
                            <td class="time">{{time this.time}}</td>
                            <td colspan="4">{{this.title}}</td>
                            <td class="assigned">{{this.speaker}}</td>
                        </tr>
                        {{/each}}
                        {{#with this.congregation_bible_study}}
                        <tr>
                            <td class="time">{{time time}}</td>
                            <td colspan="0">{{title}}</td>
                            <td class="title">Dirigente</td>
                            <td class="assigned">{{conductor}}</td>
                            <td class="title">Leitor</td>
                            <td class="assigned">{{reader}}</td>
                        </tr>
                        {{/with}}
                        <tr>
                            <td class="time">{{time 3}}</td>
                            <td colspan="5">Comentários finais</td>
                        </tr>
                        <tr>
                            <td class="time">{{time 5}}</td>
                            <td colspan="3">Cântico: <strong>{{this.closing_song}}</strong></td>
                            <td class="title">Oração</td>
                            <td class="assigned">{{this.closing_prayer}}</td>
                        </tr>
                        <tr>
                            <td colspan="6">
                                <!-- {{time false}} --><hr />
                            </td>
                        </tr>
                    </table>
                    <span class="page">Página</span>
                </td>
            </tr>
        {{/each}}
    </script>
    <script type="module">
        import * as Handlebars from 'handlebars';
        import dayjs from 'dayjs';
        import custom from 'dayjs/plugin/customParseFormat';
        import localStorageDB from 'localstoragedb';

        dayjs.extend(custom);

        const TimeManager = {
            currentTime: dayjs('19:15', 'HH:mm'),

            updateTime(minutes) {
                if (!minutes) {
                    this.currentTime = dayjs('19:15', 'HH:mm'); // Reset
                } else {
                    const temp = this.currentTime;
                    this.currentTime = this.currentTime.add(minutes, 'minutes');
                    return temp.format('HH:mm');
                }
            }
        };

        Handlebars.registerHelper('time', function (minutes) {
            return TimeManager.updateTime(minutes);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URL(location.href).searchParams;
            const meetings = (new localStorageDB('library', localStorage)).queryAll('meetings', {
                query: function(r) {
                    return Array.from(params.getAll('date')).includes(r.date);
                }
            });
            document.getElementById('boot').innerHTML = Handlebars.compile(document.getElementById('template').innerHTML)({
                meetings: meetings.map(a => a.data)
            });
        });
    </script>
</body>

</html>
